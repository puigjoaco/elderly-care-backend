<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel de Administraci√≥n - Sistema de Supervisi√≥n</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .dashboard-container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 30px;
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            font-size: 28px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
            background: rgba(255,255,255,0.2);
            padding: 10px 20px;
            border-radius: 25px;
        }

        .tabs {
            display: flex;
            background: #f7f7f7;
            border-bottom: 2px solid #e0e0e0;
        }

        .tab {
            flex: 1;
            padding: 20px;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            color: #666;
            transition: all 0.3s ease;
            position: relative;
        }

        .tab:hover {
            background: rgba(102, 126, 234, 0.1);
        }

        .tab.active {
            color: #667eea;
            background: white;
        }

        .tab.active::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 0;
            right: 0;
            height: 3px;
            background: #667eea;
        }

        .content {
            padding: 30px;
            min-height: 600px;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
            animation: fadeIn 0.3s;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 25px;
            border-radius: 15px;
            color: white;
        }

        .stat-card h3 {
            font-size: 14px;
            opacity: 0.9;
            margin-bottom: 10px;
        }

        .stat-card .value {
            font-size: 32px;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .stat-card .change {
            font-size: 12px;
            opacity: 0.8;
        }

        .section {
            background: #f9f9f9;
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 25px;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .section-title {
            font-size: 20px;
            font-weight: 600;
            color: #333;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5a67d8;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
        }

        .btn-secondary {
            background: white;
            color: #667eea;
            border: 2px solid #667eea;
        }

        .btn-secondary:hover {
            background: #667eea;
            color: white;
        }

        .btn-danger {
            background: #f56565;
            color: white;
        }

        .btn-success {
            background: #48bb78;
            color: white;
        }

        .table {
            width: 100%;
            background: white;
            border-radius: 10px;
            overflow: hidden;
        }

        .table th {
            background: #f7f7f7;
            padding: 15px;
            text-align: left;
            font-weight: 600;
            color: #666;
            border-bottom: 2px solid #e0e0e0;
        }

        .table td {
            padding: 15‡∏á‡∏≤‡∏ô;
            border-bottom: 1px solid #f0f0f0;
        }

        .table tr:hover {
            background: #f9f9f9;
        }

        .status {
            display: inline-block;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }

        .status.active {
            background: #c6f6d5;
            color: #22543d;
        }

        .status.inactive {
            background: #fed7d7;
            color: #742a2a;
        }

        .status.present {
            background: #bee3f8;
            color: #2c5282;
        }

        .activity-item {
            display: flex;
            align-items: start;
            gap: 15px;
            padding: 15px;
            background: white;
            border-radius: 10px;
            margin-bottom: 10px;
        }

        .activity-icon {
            width: 40px;
            height: 40px;
            background: #edf2f7;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
        }

        .activity-content {
            flex: 1;
        }

        .activity-title {
            font-weight: 600;
            color: #333;
            margin-bottom: 5px;
        }

        .activity-time {
            font-size: 12px;
            color: #999;
        }

        .medication-form {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            padding: 20px;
            background: white;
            border-radius: 10px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group label {
            font-weight: 600;
            color: #666;
            margin-bottom: 8px;
        }

        .form-group input, .form-group select, .form-group textarea {
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .photo-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 15px;
        }

        .photo-item {
            position: relative;
            aspect-ratio: 1;
            border-radius: 10px;
            overflow: hidden;
            cursor: pointer;
            transition: transform 0.3s ease;
        }

        .photo-item:hover {
            transform: scale(1.05);
        }

        .photo-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .photo-label {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(to top, rgba(0,0,0,0.8), transparent);
            color: white;
            padding: 10px;
            font-size: 12px;
        }

        .alert {
            padding: 15px 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .alert-warning {
            background: #fef5e7;
            border-left: 4px solid #f39c12;
            color: #7e5109;
        }

        .alert-danger {
            background: #fee;
            border-left: 4px solid #f56565;
            color: #742a2a;
        }

        .alert-success {
            background: #edfcf2;
            border-left: 4px solid #48bb78;
            color: #22543d;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 20px;
            padding: 30px;
            max-width: 500px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            margin-bottom: 20px;
        }

        .modal-title {
            font-size: 24px;
            font-weight: 600;
            color: #333;
        }

        .close-modal {
            float: right;
            font-size: 30px;
            cursor: pointer;
            color: #999;
        }

        .close-modal:hover {
            color: #333;
        }

        .real-time-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            background: #48bb78;
            border-radius: 50%;
            animation: pulse 2s infinite;
            margin-left: 10px;
        }

        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(72, 187, 120, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(72, 187, 120, 0); }
            100% { box-shadow: 0 0 0 0 rgba(72, 187, 120, 0); }
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #999;
        }

        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="dashboard-container">
        <div class="header">
            <h1>
                <span>üë®‚Äç‚öïÔ∏è</span>
                Panel de Administraci√≥n Familiar
            </h1>
            <div class="user-info">
                <span id="userName">Cargando...</span>
                <button onclick="logout()" class="btn btn-secondary" style="padding: 8px 16px;">
                    Cerrar Sesi√≥n
                </button>
            </div>
        </div>

        <div class="tabs">
            <button class="tab active" onclick="showTab('overview')">
                üìä Resumen General
            </button>
            <button class="tab" onclick="showTab('caregivers')">
                üë©‚Äç‚öïÔ∏è Cuidadoras
            </button>
            <button class="tab" onclick="showTab('medications')">
                üíä Medicamentos
            </button>
            <button class="tab" onclick="showTab('activities')">
                üìù Actividades del D√≠a
            </button>
            <button class="tab" onclick="showTab('photos')">
                üì∑ Fotos y Evidencias
            </button>
            <button class="tab" onclick="showTab('reports')">
                üìà Reportes
            </button>
            <button class="tab" onclick="showTab('settings')">
                ‚öôÔ∏è Configuraci√≥n
            </button>
        </div>

        <div class="content">
            <!-- Tab: Resumen General -->
            <div id="overview" class="tab-content active">
                <div class="stats-grid">
                    <div class="stat-card">
                        <h3>Cuidadora Actual</h3>
                        <div class="value" id="currentCaregiver">Mar√≠a Garc√≠a</div>
                        <div class="change">En turno desde 08:00 AM</div>
                    </div>
                    <div class="stat-card" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
                        <h3>Medicamentos Hoy</h3>
                        <div class="value"><span id="medsGiven">3</span>/5</div>
                        <div class="change">Pr√≥ximo: Omeprazol a las 2:00 PM</div>
                    </div>
                    <div class="stat-card" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);">
                        <h3>Comidas Registradas</h3>
                        <div class="value"><span id="mealsRecorded">2</span>/4</div>
                        <div class="change">√öltimo: Almuerzo 12:30 PM</div>
                    </div>
                    <div class="stat-card" style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);">
                        <h3>Estado del Paciente</h3>
                        <div class="value">Estable</div>
                        <div class="change">Peso: 72kg | Presi√≥n: 120/80</div>
                    </div>
                </div>

                <div class="section">
                    <div class="section-header">
                        <h2 class="section-title">
                            Alertas Importantes
                            <span class="real-time-indicator"></span>
                        </h2>
                    </div>
                    <div id="alertsContainer">
                        <div class="alert alert-warning">
                            <span>‚ö†Ô∏è</span>
                            <div>
                                <strong>Medicamento Pendiente:</strong> Losart√°n debe administrarse en 30 minutos
                            </div>
                        </div>
                    </div>
                </div>

                <div class="section">
                    <div class="section-header">
                        <h2 class="section-title">Actividad Reciente</h2>
                        <button class="btn btn-primary" onclick="refreshActivities()">
                            üîÑ Actualizar
                        </button>
                    </div>
                    <div id="recentActivities">
                        <div class="loading">
                            <div class="spinner"></div>
                            <p>Cargando actividades...</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tab: Cuidadoras -->
            <div id="caregivers" class="tab-content">
                <div class="section">
                    <div class="section-header">
                        <h2 class="section-title">Gesti√≥n de Cuidadoras</h2>
                        <button class="btn btn-primary" onclick="showAddCaregiverModal()">
                            + Nueva Cuidadora
                        </button>
                    </div>
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Nombre</th>
                                <th>ID Empleado</th>
                                <th>Tel√©fono</th>
                                <th>Turno</th>
                                <th>Estado</th>
                                <th>√öltima Actividad</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="caregiversTable">
                            <tr>
                                <td colspan="7" class="loading">Cargando cuidadoras...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <div class="section">
                    <div class="section-header">
                        <h2 class="section-title">Horarios de Turnos</h2>
                    </div>
                    <div id="shiftsCalendar">
                        <!-- Calendar view would go here -->
                    </div>
                </div>
            </div>

            <!-- Tab: Medicamentos -->
            <div id="medications" class="tab-content">
                <div class="section">
                    <div class="section-header">
                        <h2 class="section-title">Configuraci√≥n de Medicamentos</h2>
                        <button class="btn btn-primary" onclick="showAddMedicationModal()">
                            + Agregar Medicamento
                        </button>
                    </div>
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Medicamento</th>
                                <th>Dosis</th>
                                <th>Frecuencia</th>
                                <th>Horarios</th>
                                <th>Cr√≠tico</th>
                                <th>Estado</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="medicationsTable">
                            <tr>
                                <td colspan="7" class="loading">Cargando medicamentos...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <div class="section">
                    <div class="section-header">
                        <h2 class="section-title">Historial de Administraci√≥n</h2>
                    </div>
                    <div id="medicationHistory">
                        <!-- Medication history would go here -->
                    </div>
                </div>
            </div>

            <!-- Tab: Actividades del D√≠a -->
            <div id="activities" class="tab-content">
                <div class="section">
                    <div class="section-header">
                        <h2 class="section-title">
                            Timeline del D√≠a
                            <span class="real-time-indicator"></span>
                        </h2>
                        <input type="date" id="activityDate" value="" onchange="loadActivitiesByDate()">
                    </div>
                    <div id="dayTimeline">
                        <!-- Timeline would go here -->
                    </div>
                </div>
            </div>

            <!-- Tab: Fotos y Evidencias -->
            <div id="photos" class="tab-content">
                <div class="section">
                    <div class="section-header">
                        <h2 class="section-title">Fotos del D√≠a</h2>
                        <select id="photoFilter" onchange="filterPhotos()">
                            <option value="all">Todas</option>
                            <option value="meals">Comidas</option>
                            <option value="medications">Medicamentos</option>
                            <option value="weight">Peso</option>
                            <option value="attendance">Asistencia</option>
                        </select>
                    </div>
                    <div class="photo-grid" id="photoGrid">
                        <!-- Photos would go here -->
                    </div>
                </div>
            </div>

            <!-- Tab: Reportes -->
            <div id="reports" class="tab-content">
                <div class="section">
                    <div class="section-header">
                        <h2 class="section-title">Generar Reportes</h2>
                    </div>
                    <div class="medication-form">
                        <div class="form-group">
                            <label>Tipo de Reporte</label>
                            <select id="reportType">
                                <option value="daily">Reporte Diario</option>
                                <option value="weekly">Reporte Semanal</option>
                                <option value="monthly">Reporte Mensual</option>
                                <option value="medical">Reporte M√©dico Completo</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Fecha Inicio</label>
                            <input type="date" id="reportStartDate">
                        </div>
                        <div class="form-group">
                            <label>Fecha Fin</label>
                            <input type="date" id="reportEndDate">
                        </div>
                        <div class="form-group">
                            <label>Formato</label>
                            <select id="reportFormat">
                                <option value="pdf">PDF</option>
                                <option value="excel">Excel</option>
                                <option value="csv">CSV</option>
                            </select>
                        </div>
                    </div>
                    <button class="btn btn-primary" onclick="generateReport()">
                        üìä Generar Reporte
                    </button>
                </div>

                <div class="section">
                    <div class="section-header">
                        <h2 class="section-title">Reportes Anteriores</h2>
                    </div>
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Fecha</th>
                                <th>Tipo</th>
                                <th>Per√≠odo</th>
                                <th>Formato</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="reportsHistory">
                            <tr>
                                <td colspan="5" class="loading">No hay reportes generados a√∫n</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Tab: Configuraci√≥n -->
            <div id="settings" class="tab-content">
                <div class="section">
                    <div class="section-header">
                        <h2 class="section-title">Informaci√≥n del Paciente</h2>
                    </div>
                    <div class="medication-form">
                        <div class="form-group">
                            <label>Nombre Completo</label>
                            <input type="text" id="patientName" placeholder="Nombre del paciente">
                        </div>
                        <div class="form-group">
                            <label>Edad</label>
                            <input type="number" id="patientAge" placeholder="Edad">
                        </div>
                        <div class="form-group">
                            <label>Condici√≥n</label>
                            <textarea id="patientCondition" rows="3" placeholder="Descripci√≥n de la condici√≥n"></textarea>
                        </div>
                        <div class="form-group">
                            <label>Direcci√≥n</label>
                            <input type="text" id="patientAddress" placeholder="Direcci√≥n completa">
                        </div>
                        <div class="form-group">
                            <label>Radio de GPS (metros)</label>
                            <input type="number" id="gpsRadius" value="30" min="10" max="100">
                        </div>
                    </div>
                    <button class="btn btn-primary" onclick="savePatientInfo()">
                        üíæ Guardar Cambios
                    </button>
                </div>

                <div class="section">
                    <div class="section-header">
                        <h2 class="section-title">Familiares Observadores</h2>
                        <button class="btn btn-primary" onclick="showInviteFamilyModal()">
                            + Invitar Familiar
                        </button>
                    </div>
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Nombre</th>
                                <th>Email</th>
                                <th>Relaci√≥n</th>
                                <th>Contacto Principal</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="familyTable">
                            <tr>
                                <td colspan="5" class="loading">Cargando familiares...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <div class="section">
                    <div class="section-header">
                        <h2 class="section-title">Configuraci√≥n de Notificaciones</h2>
                    </div>
                    <div class="medication-form">
                        <div class="form-group">
                            <label>
                                <input type="checkbox" id="notifyMedications" checked>
                                Notificar medicamentos perdidos
                            </label>
                        </div>
                        <div class="form-group">
                            <label>
                                <input type="checkbox" id="notifyAttendance" checked>
                                Notificar entrada/salida de cuidadoras
                            </label>
                        </div>
                        <div class="form-group">
                            <label>
                                <input type="checkbox" id="notifyQuestionnaire" checked>
                                Notificar resultados de cuestionarios cr√≠ticos
                            </label>
                        </div>
                        <div class="form-group">
                            <label>
                                <input type="checkbox" id="notifyPhotos" checked>
                                Notificar fotos faltantes
                            </label>
                        </div>
                    </div>
                    <button class="btn btn-primary" onclick="saveNotificationSettings()">
                        üíæ Guardar Preferencias
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal: Add Caregiver -->
    <div id="addCaregiverModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <span class="close-modal" onclick="closeModal('addCaregiverModal')">&times;</span>
                <h2 class="modal-title">Agregar Nueva Cuidadora</h2>
            </div>
            <div class="medication-form">
                <div class="form-group">
                    <label>Nombre Completo</label>
                    <input type="text" id="newCaregiverName" placeholder="Nombre completo">
                </div>
                <div class="form-group">
                    <label>Email</label>
                    <input type="email" id="newCaregiverEmail" placeholder="email@ejemplo.com">
                </div>
                <div class="form-group">
                    <label>Tel√©fono</label>
                    <input type="tel" id="newCaregiverPhone" placeholder="+34 600 000 000">
                </div>
                <div class="form-group">
                    <label>ID de Empleado</label>
                    <input type="text" id="newCaregiverEmployeeId" placeholder="EMP001">
                </div>
                <div class="form-group">
                    <label>Turno</label>
                    <select id="newCaregiverShift">
                        <option value="morning">Ma√±ana (7:00 - 15:00)</option>
                        <option value="afternoon">Tarde (15:00 - 23:00)</option>
                        <option value="night">Noche (23:00 - 7:00)</option>
                        <option value="custom">Personalizado</option>
                    </select>
                </div>
            </div>
            <div style="margin-top: 20px;">
                <button class="btn btn-primary" onclick="createCaregiver()">
                    Crear Cuidadora
                </button>
                <button class="btn btn-secondary" onclick="closeModal('addCaregiverModal')">
                    Cancelar
                </button>
            </div>
        </div>
    </div>

    <!-- Modal: Add Medication -->
    <div id="addMedicationModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <span class="close-modal" onclick="closeModal('addMedicationModal')">&times;</span>
                <h2 class="modal-title">Agregar Medicamento</h2>
            </div>
            <div class="medication-form">
                <div class="form-group">
                    <label>Nombre del Medicamento</label>
                    <input type="text" id="newMedName" placeholder="Ej: Omeprazol">
                </div>
                <div class="form-group">
                    <label>Dosis</label>
                    <input type="text" id="newMedDose" placeholder="Ej: 20mg">
                </div>
                <div class="form-group">
                    <label>Frecuencia</label>
                    <select id="newMedFrequency">
                        <option value="once_daily">Una vez al d√≠a</option>
                        <option value="twice_daily">Dos veces al d√≠a</option>
                        <option value="three_times">Tres veces al d√≠a</option>
                        <option value="every_8_hours">Cada 8 horas</option>
                        <option value="as_needed">Seg√∫n necesidad</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Horarios (separados por coma)</label>
                    <input type="text" id="newMedSchedule" placeholder="Ej: 08:00, 20:00">
                </div>
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="newMedCritical">
                        Medicamento Cr√≠tico
                    </label>
                </div>
                <div class="form-group">
                    <label>Notas</label>
                    <textarea id="newMedNotes" rows="3" placeholder="Instrucciones especiales"></textarea>
                </div>
            </div>
            <div style="margin-top: 20px;">
                <button class="btn btn-primary" onclick="addMedication()">
                    Agregar Medicamento
                </button>
                <button class="btn btn-secondary" onclick="closeModal('addMedicationModal')">
                    Cancelar
                </button>
            </div>
        </div>
    </div>

    <script>
        // Configuration
        const SUPABASE_URL = 'http://localhost:54321';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZS1kZW1vIiwicm9sZSI6ImFub24iLCJleHAiOjE5ODM4MTI5OTZ9.CRXP1A7WOeoJeXxjNni43kdQwgnWNReilDMblYTn_I0';
        const API_URL = 'http://localhost:3001/api';

        let currentUser = null;
        let currentPatient = null;

        // Initialize Dashboard
        async function initDashboard() {
            // Check authentication
            const token = localStorage.getItem('auth_token');
            if (!token) {
                window.location.href = '/auth-ui.html';
                return;
            }

            // Load user data
            await loadUserData();
            
            // Load patient data
            await loadPatientData();

            // Initialize real-time updates
            initRealTimeUpdates();

            // Load initial data
            await Promise.all([
                loadCaregivers(),
                loadMedications(),
                refreshActivities(),
                loadFamilyMembers()
            ]);

            // Set today's date
            document.getElementById('activityDate').valueAsDate = new Date();
        }

        async function loadUserData() {
            try {
                const response = await fetch(`${API_URL}/auth/user`, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('auth_token')}`
                    }
                });

                if (!response.ok) throw new Error('Failed to load user data');

                currentUser = await response.json();
                document.getElementById('userName').textContent = currentUser.full_name || currentUser.email;
            } catch (error) {
                console.error('Error loading user:', error);
            }
        }

        async function loadPatientData() {
            try {
                const response = await fetch(`${API_URL}/patients/current`, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('auth_token')}`
                    }
                });

                if (!response.ok) throw new Error('Failed to load patient data');

                currentPatient = await response.json();
                
                // Update patient info in settings
                if (currentPatient) {
                    document.getElementById('patientName').value = currentPatient.name || '';
                    document.getElementById('patientAge').value = currentPatient.age || '';
                    document.getElementById('patientCondition').value = currentPatient.condition || '';
                    document.getElementById('patientAddress').value = currentPatient.address || '';
                    document.getElementById('gpsRadius').value = currentPatient.radius_meters || 30;
                }
            } catch (error) {
                console.error('Error loading patient:', error);
            }
        }

        function showTab(tabName) {
            // Remove active class from all tabs and contents
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));

            // Add active class to selected tab and content
            event.target.classList.add('active');
            document.getElementById(tabName).classList.add('active');
        }

        async function refreshActivities() {
            const container = document.getElementById('recentActivities');
            container.innerHTML = '<div class="loading"><div class="spinner"></div><p>Cargando actividades...</p></div>';

            try {
                const response = await fetch(`${API_URL}/activities/recent`, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('auth_token')}`
                    }
                });

                if (!response.ok) throw new Error('Failed to load activities');

                const activities = await response.json();
                displayActivities(activities);
            } catch (error) {
                console.error('Error loading activities:', error);
                container.innerHTML = '<div class="alert alert-danger">Error al cargar las actividades</div>';
            }
        }

        function displayActivities(activities) {
            const container = document.getElementById('recentActivities');
            
            if (!activities || activities.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #999;">No hay actividades recientes</p>';
                return;
            }

            container.innerHTML = activities.map(activity => `
                <div class="activity-item">
                    <div class="activity-icon">${getActivityIcon(activity.type)}</div>
                    <div class="activity-content">
                        <div class="activity-title">${activity.title}</div>
                        <div class="activity-description">${activity.description || ''}</div>
                        <div class="activity-time">${formatTime(activity.created_at)}</div>
                    </div>
                </div>
            `).join('');
        }

        function getActivityIcon(type) {
            const icons = {
                'attendance_check_in': 'üîî',
                'attendance_check_out': 'üö™',
                'medication_given': 'üíä',
                'medication_missed': '‚ö†Ô∏è',
                'meal_recorded': 'üçΩÔ∏è',
                'photo_taken': 'üì∑',
                'questionnaire_completed': 'üìù',
                'weight_recorded': '‚öñÔ∏è'
            };
            return icons[type] || 'üìå';
        }

        async function loadCaregivers() {
            const tbody = document.getElementById('caregiversTable');
            tbody.innerHTML = '<tr><td colspan="7" class="loading">Cargando cuidadoras...</td></tr>';

            try {
                const response = await fetch(`${API_URL}/caregivers`, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('auth_token')}`
                    }
                });

                if (!response.ok) throw new Error('Failed to load caregivers');

                const caregivers = await response.json();
                displayCaregivers(caregivers);
            } catch (error) {
                console.error('Error loading caregivers:', error);
                tbody.innerHTML = '<tr><td colspan="7" class="alert alert-danger">Error al cargar cuidadoras</td></tr>';
            }
        }

        function displayCaregivers(caregivers) {
            const tbody = document.getElementById('caregiversTable');
            
            if (!caregivers || caregivers.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; color: #999;">No hay cuidadoras registradas</td></tr>';
                return;
            }

            tbody.innerHTML = caregivers.map(caregiver => `
                <tr>
                    <td>${caregiver.full_name}</td>
                    <td>${caregiver.employee_id || '-'}</td>
                    <td>${caregiver.phone || '-'}</td>
                    <td>${formatShift(caregiver.shift_schedule)}</td>
                    <td><span class="status ${caregiver.is_active ? 'active' : 'inactive'}">${caregiver.is_active ? 'Activo' : 'Inactivo'}</span></td>
                    <td>${caregiver.last_activity ? formatTime(caregiver.last_activity) : 'Sin actividad'}</td>
                    <td>
                        <button class="btn btn-secondary" onclick="editCaregiver('${caregiver.id}')">Editar</button>
                        <button class="btn btn-danger" onclick="deleteCaregiver('${caregiver.id}')">Eliminar</button>
                    </td>
                </tr>
            `).join('');
        }

        async function loadMedications() {
            const tbody = document.getElementById('medicationsTable');
            tbody.innerHTML = '<tr><td colspan="7" class="loading">Cargando medicamentos...</td></tr>';

            try {
                const response = await fetch(`${API_URL}/medications`, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('auth_token')}`
                    }
                });

                if (!response.ok) throw new Error('Failed to load medications');

                const medications = await response.json();
                displayMedications(medications);
            } catch (error) {
                console.error('Error loading medications:', error);
                tbody.innerHTML = '<tr><td colspan="7" class="alert alert-danger">Error al cargar medicamentos</td></tr>';
            }
        }

        function displayMedications(medications) {
            const tbody = document.getElementById('medicationsTable');
            
            if (!medications || medications.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; color: #999;">No hay medicamentos configurados</td></tr>';
                return;
            }

            tbody.innerHTML = medications.map(med => `
                <tr>
                    <td>${med.name}</td>
                    <td>${med.dose}</td>
                    <td>${med.frequency}</td>
                    <td>${med.schedule_times ? med.schedule_times.join(', ') : '-'}</td>
                    <td>${med.is_critical ? '‚ö†Ô∏è S√≠' : 'No'}</td>
                    <td><span class="status active">Activo</span></td>
                    <td>
                        <button class="btn btn-secondary" onclick="editMedication('${med.id}')">Editar</button>
                        <button class="btn btn-danger" onclick="deleteMedication('${med.id}')">Eliminar</button>
                    </td>
                </tr>
            `).join('');
        }

        async function loadFamilyMembers() {
            const tbody = document.getElementById('familyTable');
            tbody.innerHTML = '<tr><td colspan="5" class="loading">Cargando familiares...</td></tr>';

            try {
                const response = await fetch(`${API_URL}/family-members`, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('auth_token')}`
                    }
                });

                if (!response.ok) throw new Error('Failed to load family members');

                const members = await response.json();
                displayFamilyMembers(members);
            } catch (error) {
                console.error('Error loading family members:', error);
                tbody.innerHTML = '<tr><td colspan="5" class="alert alert-danger">Error al cargar familiares</td></tr>';
            }
        }

        function displayFamilyMembers(members) {
            const tbody = document.getElementById('familyTable');
            
            if (!members || members.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; color: #999;">No hay familiares observadores</td></tr>';
                return;
            }

            tbody.innerHTML = members.map(member => `
                <tr>
                    <td>${member.full_name}</td>
                    <td>${member.email}</td>
                    <td>${member.relationship || '-'}</td>
                    <td>${member.is_primary_contact ? '‚úì S√≠' : 'No'}</td>
                    <td>
                        <button class="btn btn-danger" onclick="removeFamilyMember('${member.id}')">Eliminar</button>
                    </td>
                </tr>
            `).join('');
        }

        function showAddCaregiverModal() {
            document.getElementById('addCaregiverModal').classList.add('active');
        }

        function showAddMedicationModal() {
            document.getElementById('addMedicationModal').classList.add('active');
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }

        async function createCaregiver() {
            const caregiverData = {
                full_name: document.getElementById('newCaregiverName').value,
                email: document.getElementById('newCaregiverEmail').value,
                phone: document.getElementById('newCaregiverPhone').value,
                employee_id: document.getElementById('newCaregiverEmployeeId').value,
                shift: document.getElementById('newCaregiverShift').value
            };

            try {
                const response = await fetch(`${API_URL}/auth/create-caregiver`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('auth_token')}`
                    },
                    body: JSON.stringify(caregiverData)
                });

                if (!response.ok) throw new Error('Failed to create caregiver');

                const result = await response.json();
                alert(`Cuidadora creada exitosamente. Contrase√±a temporal: ${result.temporaryPassword}`);
                
                closeModal('addCaregiverModal');
                await loadCaregivers();
            } catch (error) {
                console.error('Error creating caregiver:', error);
                alert('Error al crear la cuidadora. Por favor, intente nuevamente.');
            }
        }

        async function addMedication() {
            const medicationData = {
                name: document.getElementById('newMedName').value,
                dose: document.getElementById('newMedDose').value,
                frequency: document.getElementById('newMedFrequency').value,
                schedule_times: document.getElementById('newMedSchedule').value.split(',').map(t => t.trim()),
                is_critical: document.getElementById('newMedCritical').checked,
                notes: document.getElementById('newMedNotes').value,
                patient_id: currentPatient?.id
            };

            try {
                const response = await fetch(`${API_URL}/medications`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('auth_token')}`
                    },
                    body: JSON.stringify(medicationData)
                });

                if (!response.ok) throw new Error('Failed to add medication');

                alert('Medicamento agregado exitosamente');
                closeModal('addMedicationModal');
                await loadMedications();
            } catch (error) {
                console.error('Error adding medication:', error);
                alert('Error al agregar el medicamento. Por favor, intente nuevamente.');
            }
        }

        async function savePatientInfo() {
            const patientData = {
                name: document.getElementById('patientName').value,
                age: parseInt(document.getElementById('patientAge').value),
                condition: document.getElementById('patientCondition').value,
                address: document.getElementById('patientAddress').value,
                radius_meters: parseInt(document.getElementById('gpsRadius').value)
            };

            try {
                const response = await fetch(`${API_URL}/patients/${currentPatient?.id || 'new'}`, {
                    method: currentPatient ? 'PUT' : 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('auth_token')}`
                    },
                    body: JSON.stringify(patientData)
                });

                if (!response.ok) throw new Error('Failed to save patient info');

                alert('Informaci√≥n del paciente guardada exitosamente');
                await loadPatientData();
            } catch (error) {
                console.error('Error saving patient info:', error);
                alert('Error al guardar la informaci√≥n. Por favor, intente nuevamente.');
            }
        }

        async function generateReport() {
            const reportData = {
                type: document.getElementById('reportType').value,
                startDate: document.getElementById('reportStartDate').value,
                endDate: document.getElementById('reportEndDate').value,
                format: document.getElementById('reportFormat').value
            };

            try {
                const response = await fetch(`${API_URL}/reports/generate`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('auth_token')}`
                    },
                    body: JSON.stringify(reportData)
                });

                if (!response.ok) throw new Error('Failed to generate report');

                // Handle download
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `report_${reportData.type}_${new Date().toISOString().split('T')[0]}.${reportData.format}`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);

                alert('Reporte generado exitosamente');
            } catch (error) {
                console.error('Error generating report:', error);
                alert('Error al generar el reporte. Por favor, intente nuevamente.');
            }
        }

        function initRealTimeUpdates() {
            // In a real implementation, this would use WebSockets or Server-Sent Events
            // For now, we'll poll for updates every 30 seconds
            setInterval(() => {
                refreshActivities();
                updateAlerts();
            }, 30000);
        }

        async function updateAlerts() {
            try {
                const response = await fetch(`${API_URL}/alerts/active`, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('auth_token')}`
                    }
                });

                if (!response.ok) return;

                const alerts = await response.json();
                displayAlerts(alerts);
            } catch (error) {
                console.error('Error updating alerts:', error);
            }
        }

        function displayAlerts(alerts) {
            const container = document.getElementById('alertsContainer');
            
            if (!alerts || alerts.length === 0) {
                container.innerHTML = '<div class="alert alert-success"><span>‚úÖ</span><div>No hay alertas activas en este momento</div></div>';
                return;
            }

            container.innerHTML = alerts.map(alert => {
                const alertClass = alert.priority === 'high' ? 'alert-danger' : 
                                  alert.priority === 'medium' ? 'alert-warning' : 'alert-success';
                const icon = alert.priority === 'high' ? 'üö®' : 
                           alert.priority === 'medium' ? '‚ö†Ô∏è' : '‚ÑπÔ∏è';
                
                return `
                    <div class="alert ${alertClass}">
                        <span>${icon}</span>
                        <div>
                            <strong>${alert.title}:</strong> ${alert.message}
                            ${alert.action ? `<button class="btn btn-secondary" onclick="${alert.action}">${alert.actionText}</button>` : ''}
                        </div>
                    </div>
                `;
            }).join('');
        }

        function formatTime(timestamp) {
            const date = new Date(timestamp);
            const now = new Date();
            const diff = (now - date) / 1000; // difference in seconds

            if (diff < 60) return 'Hace un momento';
            if (diff < 3600) return `Hace ${Math.floor(diff / 60)} minutos`;
            if (diff < 86400) return `Hace ${Math.floor(diff / 3600)} horas`;
            
            return date.toLocaleDateString('es-ES', { 
                day: 'numeric', 
                month: 'short', 
                hour: '2-digit', 
                minute: '2-digit' 
            });
        }

        function formatShift(schedule) {
            if (!schedule) return 'No definido';
            
            // This would parse the JSON schedule and format it nicely
            try {
                const s = typeof schedule === 'string' ? JSON.parse(schedule) : schedule;
                return Object.entries(s).map(([day, times]) => 
                    `${day}: ${times.start}-${times.end}`
                ).join(', ');
            } catch {
                return 'Personalizado';
            }
        }

        async function logout() {
            localStorage.removeItem('auth_token');
            localStorage.removeItem('user_role');
            window.location.href = '/auth-ui.html';
        }

        // Initialize on page load
        window.addEventListener('DOMContentLoaded', initDashboard);
    </script>
</body>
</html>